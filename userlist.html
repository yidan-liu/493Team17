<!doctype html>
<!-- See http://www.firepad.io/docs/ for detailed embedding docs. -->
<html>

<head>
  <meta charset="utf-8" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>

 <!-- ACE and its JavaScript mode and theme files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/mode-javascript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/theme-textmate.js"></script>

  <!-- CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.17.0/codemirror.css" />

  <!-- Firepad -->
<!--  <link rel="stylesheet" href="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.css" /> -->
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.firebase.com/libs/firepad/1.4.0/firepad.min.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- JQuery Chat -->
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.2/themes/smoothness/jquery-ui.css" type="text/css" media="screen" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link type="text/css" href="jquery.ui.chatbox.css" rel="stylesheet" />
    <script type="text/javascript" src="jquery.ui.chatbox.js"></script>

  <!-- Include example userlist script / CSS.
       Can be downloaded from: https://github.com/firebase/firepad/tree/master/examples/ -->
  
  <script src="firepad-userlist.js"></script>
  <link rel="stylesheet" href="firepad-userlist.css" />


</head>

<body>
  <div id="left-panel">
<div id="title">
    <h1>CodeLock</h1>        
<h4>By Team 17 <button id="help-btn" class="help-button" title="Welcome to CodeLock!

Type your code in the middle of the screen. It recognizes JavaScript and HTML. Your cursor will match your user color.

Press the lock button in the top right of the screen. Any highlighted text will now be only edited by you until you press the button again to unlock. While code is locked by you, other users will not be able to edit it until you unlock.

'Save' will saves the current code; 'Revert' will change the current code back to the saved code.

'Run' evaluates and outputs Javascript or outputs HTML.

'Choose Language' is a drop down menu that allows you to select which language you're using.

You can edit your name by clicking on it and typing a new one. Rejoining the session will reset it.

Use the chat box at the bottom left to talk. Click the chat bar to minimize/maximize.

The output of 'Run' will print in the console below the coding area.

Compile errors and warnings will appear in the terminal on the right side.

">?</button>
</h4>
</div>
       

    <hr>
    <button type="button" class="btn btn-default btn-lg" style="width:100%;" id="save-btn" onclick="saveVersion()">Save</button>
    <button type="button" class="btn btn-default btn-lg" style="width:100%;" id="revert-btn" onclick="revertVersion()">Revert</button>
    <button type="button" class="btn btn-default btn-lg" style="width:100%;" id="run-btn" onclick="run()">Run</button>
    <div class="dropdown">
      <button type="button" id="dropbtn" class="btn btn-default btn-lg">Select Language &#9662;</button>
      <div class="dropdown-content">
        <a onclick="changeLanguage('javascript')">JavaScript</a>
        <a onclick="changeLanguage('html')">HTML</a>
      </div>
    </div>


    <hr>
  </div>
  <div id="firepad-container"></div>
  <div id="userlist"></div>
  <div id="chat_div"></div>
  <div id="lock">
    <button id="lock-btn" class="btn btn-default btn-lg" onclick="toggleCode()">&#128275;</button>
    <!-- <button id="lock-btn" class="btn btn-default btn-lg" onclick="toggleCode()">&#128274;</button> -->
  </div>
  <iframe id="frame"></iframe>
  <div id="console">
    <p id="console-text">Output:</p>
    <p id="print-output" style="font-family: monospace; font-size: 15px; margin-left: 5px"></p>
  </div>
  
  <script>
    var username = "test";
    var version = '';
    var firepad;
    var firepadRef;
    var session; 
    
    $(document).ready(function(){
      initFirepad();
      initChat();

    });

    function toggleCode(lockUnlock) {
      
    }
    
    function changeLanguage(language) {
      session.setMode("ace/mode/" + language);
      if(language == "html") {
        $("#dropbtn").html("HTML &#9662;");
        $("#firepad-container").css({"width": "45%", "height": "100%", "min-width": "300px"});
        $("#console").css({"width": "40%", "height": "100%", "min-width": "250px"});
        //$("#console-text").html("iframe goes here")
        $("#frame").attr("srcdoc", firepad.getText());
        $("#frame").css({"width": "40%", "height": "100%", "min-width": "250px", "display": "initial", "right": "0px", "position":"absolute"});
        $("#console-text").css("display", "none");
        $("#lock-btn").css("display", "none");
      }
      else { // if (language == "javascript")
        $("#dropbtn").html("Javascript &#9662;");
        $("#firepad-container").css({"width": "85%", "height": "75%", "min-width": "600px"});
        $("#console").css({"width": "85%", "height": "25%", "min-width": "600px"});
        $("#console-text").html("Output:");
        $("#console-text").css("display", "initial");
        $("#frame").css("display", "none");
        $("#lock-btn").css("display", "initial");
      }
    }

    $("#firepad-container").resizable();
    $('#firepad-container').resize(function(){
       $('#console').height($(window).height()-$("#firepad-container").height()); 
    });
    
    function saveVersion() {
      version = firepad.getText();
    }

    function revertVersion() {
      firepad.setText(version);
    }

    function run() {
      $('#print-output').text("")
      var excute_code = firepad.getText()
      var result = eval(excute_code);
      $('#print-output').text(">>>  " + result)
    }

    function initChat(chat_username) {
      // insert existing messages
      var messagesRef = firepadRef.child('messages');
      messagesRef.off();

      var box = $("#chat_div").chatbox({id: username, 
                                    user:{key : "value"},
                                    title : "Chat",
                                    messageSent : function(id, user, msg) {
                                        messagesRef.push({
                                          name: id,
                                          text: msg
                                        });
                                    }});



      $("#chat_div").chatbox("option", "boxManager").toggleContent();

      var setMessage = function(data) {
        var val = data.val();
        //console.log(val);
        $("#chat_div").chatbox("option", "boxManager").addMsg(val.name, val.text);
      };
      messagesRef.limitToLast(12).on('child_added', setMessage);
      messagesRef.limitToLast(12).on('child_changed', setMessage);

    }
    
    function initFirepad() {
      //// Initialize Firebase.
      var config = {
        apiKey: "AIzaSyDdMbehd1XnIMu8oGTWkoylBjQoZVOQwqE",
        authDomain: "team17-62680.firebaseapp.com",
        databaseURL: "https://team17-62680.firebaseio.com"
      };
      firebase.initializeApp(config);
      //// Get Firebase Database reference.
      firepadRef = getExampleRef();
      //// Create ACE
      var editor = ace.edit("firepad-container");
      editor.setTheme("ace/theme/textmate");
      session = editor.getSession();
      session.setUseWrapMode(true);
      session.setUseWorker(false);
      session.setMode("ace/mode/javascript");

      // Create a random ID to use as our user ID (we must give this to firepad and FirepadUserList).
      var userId = Math.floor(Math.random() * 9999999999).toString();
      //// Create Firepad.
      firepad = Firepad.fromACE(firepadRef, editor, {
        defaultText: '// JavaScript Editing with Firepad!\nfunction go() {\n  var message = "Hello, world.";\n  console.log(message);\n}',
        userId:userId
      });
      //// Create FirepadUserList (with our desired userId).
      var firepadUserList = FirepadUserList.fromDiv(firepadRef.child('users'),
          document.getElementById('userlist'), userId);

      var currUserRef = firepadRef.child('users/' + userId);

      // Update chat userId once with assigned Guest name
      currUserRef.once("value").then(function(snapshot) {
         console.log(snapshot.val()['name']);
         username = snapshot.val()['name'];
         $("#chat_div").chatbox("option", "id", username);
      }, function (error) {
         console.log("Error: " + error.code);
      });

      // then track chat name changes 
      var changeName = function(data) {
        var val = data.val();
        console.log(val);
        username = val;
        $("#chat_div").chatbox("option", "id", val);
      };
      currUserRef.on('child_changed', changeName);
    }

    // Helper to get hash from end of URL or generate a random one.
    function getExampleRef() {
      var ref = firebase.database().ref();
      //ref.remove();
      var hash = window.location.hash.replace(/#/g, '');
      if (hash) {
        ref = ref.child(hash);
      } else {
        ref = ref.push(); // generate unique location.
        window.location = window.location + '#' + ref.key; // add it as a hash to the URL.
      }
      if (typeof console !== 'undefined') {
        console.log('Firebase data: ', ref.toString());
      }
      return ref;
    }

  </script>
</body>
</html>
